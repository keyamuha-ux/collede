<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Club Dashboard | Collede</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/theme.css">
    <script
      async
      crossorigin="anonymous"
      data-clerk-publishable-key="pk_test_YXJyaXZpbmctYXNwLTIuY2xlcmsuYWNjb3VudHMuZGV2JA"
      src="https://arriving-asp-2.clerk.accounts.dev/npm/@clerk/clerk-js@latest/dist/clerk.browser.js"
      type="text/javascript"
    ></script>
</head>
<body class="bg-[#fffaf0] selection:bg-[#ffb7c5]/30">
    <nav class="border-b-4 border-[#ffb7c5]/20 bg-white/80 backdrop-blur-md sticky top-0 z-50">
        <div class="container mx-auto px-6 h-16 flex items-center justify-between">
            <div class="flex items-center space-x-8">
                <a href="/" class="flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#ffb7c5" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>
                    <span class="text-xl font-black tracking-tight text-[#ffb7c5]">Collede</span>
                </a>
                <div class="hidden md:flex items-center space-x-8">
                    <a href="/dashboard" class="text-sm font-bold text-[#ffb7c5] underline decoration-4 underline-offset-8">Dashboard</a>
                </div>
            </div>
            <div id="user-button"></div>
        </div>
    </nav>

    <main class="container mx-auto px-6 py-12">
        <div class="max-w-5xl mx-auto">
            <header class="mb-12 relative">
                <div class="marginalia -top-8 -left-8 rotate-[-5deg] text-[#ffb7c5] opacity-50 pointer-events-none">"Working hard, or hardly working？" ✦</div>
                <h1 class="text-5xl font-black text-[#ffb7c5] mb-4">Member Dashboard</h1>
                <p class="text-gray-500 font-bold text-lg italic">"Everything you need to keep the club running smoothly！"</p>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
                <!-- Usage Card -->
                <div class="lg:col-span-1">
                    <div class="card p-8 hand-drawn h-full">
                        <h2 class="text-xs font-black text-[#ffb7c5] uppercase tracking-widest mb-6">Today's Activity</h2>
                        <div class="space-y-6">
                            <div class="relative pt-1">
                                <div class="flex mb-2 items-center justify-between">
                                    <div>
                                        <span class="text-xs font-black inline-block py-1 px-2 uppercase rounded-full text-[#ffb7c5] bg-[#ffb7c5]/10 border border-[#ffb7c5]/20">
                                            Daily Usage
                                        </span>
                                    </div>
                                    <div class="text-right">
                                        <span id="usage-text" class="text-xs font-black inline-block text-[#ffb7c5]">
                                            0 / 13,000
                                        </span>
                                    </div>
                                </div>
                                <div class="overflow-hidden h-4 mb-4 text-xs flex rounded-full bg-[#ffb7c5]/10 shadow-inner border border-[#ffb7c5]/20">
                                    <div id="usage-bar" style="width:0%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-[#ffb7c5] transition-all duration-500"></div>
                                </div>
                            </div>
                            <p class="text-xs font-bold text-[#ffb7c5]/70 italic">
                                Each club member has a daily limit of <span class="text-[#ffb7c5]">13,000</span> requests. It resets at midnight！
                            </p>
                        </div>
                    </div>
                </div>

                <!-- API Keys Card -->
                <div class="lg:col-span-2">
                    <div class="card p-8 hand-drawn-alt min-h-[400px]">
                        <div class="flex items-center justify-between mb-8">
                            <h2 class="text-xs font-black text-blue-400 uppercase tracking-widest">Your Club Secrets</h2>
                            <button id="generate-key-btn" class="w-full bg-[#ffb7c5] hover:bg-[#ffaab9] text-white font-black py-4 px-6 rounded-2xl transition-all duration-300 shadow-lg shadow-[#ffb7c5]/20 flex items-center justify-center space-x-2 group active:scale-95 transform">
                                <span>Generate Secret Key</span>
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="group-hover:translate-x-1 transition-transform"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                            </button>
                        </div>
                        <div id="keys-loading" class="space-y-4 hidden">
                            <div class="h-16 bg-[#ffb7c5]/5 rounded-2xl border-2 border-[#ffb7c5]/20 animate-pulse"></div>
                            <div class="h-16 bg-[#ffb7c5]/5 rounded-2xl border-2 border-[#ffb7c5]/20 animate-pulse"></div>
                        </div>

                        <div id="keys-list" class="space-y-4">
                            <!-- Keys will be loaded here -->
                        </div>

                        <div id="empty-keys" class="hidden py-12 text-center">
                            <div class="text-4xl mb-4">✦</div>
                            <p class="text-gray-400 font-bold">No secrets yet... why not write one？</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Integration Section -->
            <section class="mt-16">
                <div class="card p-10 hand-drawn bg-white relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-8 opacity-5 text-8xl rotate-12">⧈</div>
                    <h2 class="text-3xl font-black text-[#ffb7c5] mb-8">How to use your secrets</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                        <div>
                            <h3 class="font-black text-gray-700 mb-4 flex items-center">
                                <span class="w-8 h-8 rounded-full bg-[#ffb7c5]/20 text-[#ffb7c5] flex items-center justify-center mr-3 text-sm">1</span>
                                Set your Base URL
                            </h3>
                            <div class="bg-gray-50 p-4 rounded-2xl border-2 border-[#ffb7c5]/10 font-mono text-sm text-[#ffb7c5] break-all shadow-inner">
                                http://localhost:3000/v1
                            </div>
                        </div>
                        <div>
                            <h3 class="font-black text-gray-700 mb-4 flex items-center">
                                <span class="w-8 h-8 rounded-full bg-blue-100 text-blue-500 flex items-center justify-center mr-3 text-sm">2</span>
                                Use your API Key
                            </h3>
                            <p class="text-gray-500 font-bold text-sm leading-relaxed">
                                Simply pass your generated secret as a Bearer token in the Authorization header. It works with any OpenAI-compatible SDK！
                            </p>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Modal for new key -->
    <div id="key-modal" class="fixed inset-0 z-[100] flex items-center justify-center px-6 hidden">
        <div class="absolute inset-0 bg-[#ffb7c5]/20 backdrop-blur-sm"></div>
        <div class="card p-10 max-w-md w-full relative z-10 hand-drawn shadow-2xl bg-white">
            <h3 class="text-3xl font-black text-[#ffb7c5] mb-2">New Club Secret！</h3>
            <p class="text-gray-500 font-bold mb-8">Give your secret a name so you don't forget it.</p>
            
            <input type="text" id="key-name-input" placeholder="e.g. My Awesome App" 
                class="w-full bg-[#ffb7c5]/5 border-2 border-[#ffb7c5]/20 rounded-2xl px-6 py-4 text-gray-700 font-medium focus:outline-none focus:border-[#ffb7c5] transition mb-8 shadow-inner">
            
            <div class="flex space-x-4">
                <button id="cancel-modal" class="flex-1 px-6 py-4 rounded-2xl font-black text-gray-400 hover:text-gray-600 transition">Cancel</button>
                <button id="confirm-generate" class="flex-1 btn-primary px-6 py-4 rounded-2xl font-black shadow-xl">Generate</button>
            </div>
        </div>
    </div>

    <!-- Modal for showing generated key -->
    <div id="show-key-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center px-6">
        <div class="absolute inset-0 bg-blue-200/40 backdrop-blur-sm"></div>
        <div class="card p-10 max-w-lg w-full relative z-10 hand-drawn-alt shadow-2xl bg-white">
            <div class="flex flex-col items-center mb-8">
                <span class="text-4xl text-[#ffb7c5] mb-2">！</span>
                <p class="text-gray-500 text-sm font-bold italic">Please save this key now. You won't be able to see it again！</p>
            </div>

            <div class="relative mb-8">
                <div id="generated-key-display" class="w-full bg-gray-50 border-2 border-[#ffb7c5]/20 rounded-2xl px-6 py-4 font-mono text-sm text-[#ffb7c5] break-all shadow-inner pr-14">
                    collede-sk-................................
                </div>
                <button id="copy-key-btn" class="absolute right-4 top-1/2 -translate-y-1/2 text-[#ffb7c5]/40 hover:text-[#ffb7c5] transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                </button>
            </div>
            
            <button id="close-show-modal" class="w-full btn-primary px-6 py-4 rounded-2xl font-black shadow-xl">I've saved it！</button>
        </div>
    </div>

    <script>
        window.addEventListener('load', async function () {
            await Clerk.load();

            if (!Clerk.user) {
                window.location.href = '/';
                return;
            }

            Clerk.mountUserButton(document.getElementById('user-button'));
            loadDashboard();

            // UI Elements
            const generateBtn = document.getElementById('generate-key-btn');
            const keyModal = document.getElementById('key-modal');
            const cancelModal = document.getElementById('cancel-modal');
            const confirmGenerate = document.getElementById('confirm-generate');
            const keyNameInput = document.getElementById('key-name-input');
            const showKeyModal = document.getElementById('show-key-modal');
            const generatedKeyDisplay = document.getElementById('generated-key-display');
            const copyKeyBtn = document.getElementById('copy-key-btn');
            const closeShowModal = document.getElementById('close-show-modal');

            generateBtn.onclick = () => {
                keyModal.classList.remove('hidden');
                keyNameInput.focus();
            };

            cancelModal.onclick = () => {
                keyModal.classList.add('hidden');
                keyNameInput.value = '';
            };

            confirmGenerate.onclick = async () => {
                const name = keyNameInput.value.trim();
                confirmGenerate.disabled = true;
                confirmGenerate.innerText = 'Generating...';

                try {
                    const token = await Clerk.session.getToken();
                    const response = await fetch('/api/user/keys', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ name })
                    });
                    
                    const data = await response.json();
                    if (data.key) {
                        keyModal.classList.add('hidden');
                        keyNameInput.value = '';
                        generatedKeyDisplay.innerText = data.key;
                        showKeyModal.classList.remove('hidden');
                        loadDashboard(); // Refresh list
                    }
                } catch (e) {
                    alert('Failed to generate key');
                } finally {
                    confirmGenerate.disabled = false;
                    confirmGenerate.innerText = 'Generate';
                }
            };

            closeShowModal.onclick = () => {
                showKeyModal.classList.add('hidden');
            };

            copyKeyBtn.onclick = () => {
                navigator.clipboard.writeText(generatedKeyDisplay.innerText);
                copyKeyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>';
                setTimeout(() => {
                    copyKeyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>';
                }, 2000);
            };

            async function loadDashboard() {
                try {
                    const token = await Clerk.session.getToken();
                    const response = await fetch('/api/user/data', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const data = await response.json();

                    // Update usage
                    const usageText = document.getElementById('usage-text');
                    const usageBar = document.getElementById('usage-bar');
                    const percent = Math.min((data.usage.current / data.usage.limit) * 100, 100);
                    
                    usageText.innerText = `${data.usage.current.toLocaleString()} / ${data.usage.limit.toLocaleString()}`;
                    usageBar.style.width = `${percent}%`;

                    // Update keys
                    const keysList = document.getElementById('keys-list');
                    const emptyKeys = document.getElementById('empty-keys');

                    if (data.keys.length === 0) {
                        keysList.innerHTML = '';
                        emptyKeys.classList.remove('hidden');
                    } else {
                        emptyKeys.classList.add('hidden');
                        keysList.innerHTML = data.keys.map(key => `
                            <div class="flex items-center justify-between p-5 bg-white border-2 border-[#ffb7c5]/10 rounded-2xl hover:border-[#ffb7c5]/20 transition-colors shadow-sm group">
                                <div class="flex-1 min-w-0 mr-4">
                                    <h4 class="font-black text-gray-700 truncate mb-1">${key.name}</h4>
                                    <div class="flex items-center space-x-3">
                                        <code class="text-[11px] bg-[#ffb7c5]/5 px-3 py-1 rounded-lg text-[#ffb7c5] font-mono">${key.key}</code>
                                        <span class="text-[10px] font-black text-gray-300 uppercase tracking-widest">Added ${new Date(key.created).toLocaleDateString()}</span>
                                    </div>
                                </div>
                                <button onclick="revokeKey('${key.id}')" class="p-3 text-gray-300 hover:text-red-400 transition-colors opacity-0 group-hover:opacity-100">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                                </button>
                            </div>
                        `).join('');
                    }
                } catch (e) {
                    console.error('Failed to load dashboard:', e);
                }
            }

            window.revokeKey = async (id) => {
                if (!confirm('Are you sure you want to revoke this secret？ It will stop working immediately！')) return;
                
                try {
                    const token = await Clerk.session.getToken();
                    await fetch(`/api/user/keys/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    loadDashboard();
                } catch (e) {
                    alert('Failed to revoke key');
                }
            };
        });
    </script>
</body>
</html>
